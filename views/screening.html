<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screening - PreeCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7c3aed',
                        secondary: '#ec4899',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-pink-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìã</span>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        Screening Preeklampsi
                    </h1>
                </div>
                <button onclick="goHome()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold px-4 py-2 rounded-xl text-sm shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Home
                </button>
            </div>
        </div>

        <!-- Pilihan Awal -->
        <div id="pilihanCard" class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-2">Screening Ibu Hamil</h2>
            <p class="text-sm text-gray-500 mb-6">Pilih opsi untuk memulai</p>

            <div class="space-y-3">
                <button onclick="showTambahBaru()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Tambah Warga Baru
                </button>
                <button onclick="showLanjutkanData()" class="w-full bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Lanjutkan Data yang Ada
                </button>
                <button onclick="showEditData()" class="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Edit Data Warga
                </button>
            </div>
        </div>

        <!-- Form Tambah Warga Baru -->
        <div id="formWargaCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="showPilihan()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <h2 class="text-xl font-bold text-gray-900 mb-6">Data Warga</h2>
            
            <div id="wargaAlert"></div>
            
            <form id="formWarga" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="wargaNama" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">NIK</label>
                    <input type="text" id="wargaNIK" required maxlength="16"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">No Registrasi</label>
                    <input type="text" id="wargaNoReg" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nakes/Kader</label>
                    <input type="text" id="wargaNakesKader" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1.5">Otomatis terisi dengan nama Anda, dapat diubah jika perlu</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Dx (Diagnosa)</label>
                    <input type="text" id="wargaDx" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all mt-6">
                    Lanjut ke Screening
                </button>
            </form>
        </div>

        <!-- Pilih Warga yang Ada -->
        <div id="pilihanWargaCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="showPilihan()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <h2 class="text-xl font-bold text-gray-900 mb-6">Pilih Warga</h2>
            
            <div id="loadingWarga" class="hidden text-center py-12">
                <div class="inline-block w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                <p class="text-sm text-gray-500 mt-4">Memuat data...</p>
            </div>
            
            <div id="wargaListContainer"></div>
        </div>

        <!-- Edit Data Warga -->
        <div id="editDataCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="showPilihan()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <h2 class="text-xl font-bold text-gray-900 mb-6">Edit Data Warga</h2>
            
            <div id="loadingEditWarga" class="hidden text-center py-12">
                <div class="inline-block w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                <p class="text-sm text-gray-500 mt-4">Memuat data...</p>
            </div>
            
            <div id="editWargaListContainer"></div>
        </div>

        <!-- Form Edit Warga -->
        <div id="formEditWargaCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="backToEditList()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <h2 class="text-xl font-bold text-gray-900 mb-6">Edit Data Warga</h2>
            
            <div id="editAlert"></div>
            
            <form id="formEditWarga" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="editWargaNama" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">NIK</label>
                    <input type="text" id="editWargaNIK" required maxlength="16"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">No Registrasi</label>
                    <input type="text" id="editWargaNoReg" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nakes/Kader</label>
                    <input type="text" id="editWargaNakesKader" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Dx (Diagnosa)</label>
                    <input type="text" id="editWargaDx" required
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1.5">Bisa kosong jika belum ada diagnosa</p>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                        Simpan Perubahan
                    </button>
                    <button type="button" onclick="confirmDeleteWarga()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                        Hapus Data
                    </button>
                </div>
            </form>
        </div>

        <!-- Form Screening -->
        <div id="screeningCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="backToFormWarga()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Screening Preeklampsi</h2>
            <p class="text-sm text-gray-500 mb-6" id="screeningSubtitle"></p>

            <!-- Error Alert (Hidden by default) -->
            <div id="screeningErrorAlert" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-4">
                <p class="text-sm font-semibold text-red-800">‚ö†Ô∏è Mohon jawab semua pertanyaan terlebih dahulu!</p>
            </div>

            <div id="pertanyaanContainer" class="space-y-4"></div>

            <div class="flex gap-3 mt-6">
                <button onclick="hitungHasil()" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Selesai
                </button>
                <button onclick="resetScreening()" class="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Reset
                </button>
            </div>
        </div>

        <!-- Hasil Screening -->
        <div id="hasilCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-8 text-center text-white mb-6 shadow-lg">
                <h2 class="text-xl font-bold mb-4">Hasil Screening</h2>
                <div id="hasilSkor" class="text-6xl font-bold mb-4">0</div>
                <div id="hasilKategori" class="text-lg font-semibold bg-white/20 backdrop-blur-sm rounded-xl py-3 px-6 mb-4 inline-block">-</div>
                <div id="hasilRekomendasi" class="text-sm leading-relaxed opacity-95">-</div>
            </div>

            <div class="space-y-3">
                <button onclick="simpanHasil()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Simpan & Lihat Riwayat
                </button>
                <button onclick="resetKeScreening()" class="w-full bg-white hover:bg-gray-50 text-purple-600 font-semibold py-3.5 px-6 rounded-xl border-2 border-purple-600 transition-all">
                    Reset Screening
                </button>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 text-center mb-2">Hapus Data Warga?</h3>
                <p class="text-sm text-gray-600 text-center mb-6">Data warga "<span id="deleteWargaNama" class="font-bold text-gray-900"></span>" dan semua riwayat pemeriksaan akan dihapus permanen. Tindakan ini tidak dapat dibatalkan.</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-xl transition-all">
                        Batal
                    </button>
                    <button onclick="deleteWarga()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all">
                        Ya, Hapus
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = '/';
        }

        let currentWargaId = null;
        let currentWargaData = null;
        let currentEditWargaId = null;
        let currentEditWargaNama = null;
        let jawaban = {};

        const pertanyaanList = [
            { key: 'penghasilanKurangUMR', text: 'Penghasilan < UMR', nilai: 1 },
            { key: 'hamilLebihSatuKali', text: 'Hamil lebih dari 1 kali', nilai: 1 },
            { key: 'keturunanKeracunan', text: 'Ada Keturunan Preeklampsia', nilai: 2 },
            { key: 'usiaBerisiko', text: 'Usia < 20 th atau > 35 th', nilai: 2 },
            { key: 'riwayatTekananDarah', text: 'Ada Riwayat tekanan darah tinggi', nilai: 5 },
            { key: 'gemuk', text: 'Gemuk (IMT > 25)', nilai: 6 },
            { key: 'riwayatKeracunan', text: 'Ada Riwayat Preeklampsia', nilai: 8 },
            { key: 'riwayatDM', text: 'Ada Riwayat kencing manis (DM)', nilai: 8 }
        ];

        function showPilihan() {
            document.getElementById('pilihanCard').classList.remove('hidden');
            document.getElementById('formWargaCard').classList.add('hidden');
            document.getElementById('pilihanWargaCard').classList.add('hidden');
            document.getElementById('editDataCard').classList.add('hidden');
            document.getElementById('formEditWargaCard').classList.add('hidden');
            document.getElementById('screeningCard').classList.add('hidden');
            document.getElementById('hasilCard').classList.add('hidden');
        }

        function showTambahBaru() {
            document.getElementById('pilihanCard').classList.add('hidden');
            document.getElementById('formWargaCard').classList.remove('hidden');
            
            // Auto-fill Nakes/Kader dengan nama lengkap user yang login
            document.getElementById('wargaNakesKader').value = localStorage.getItem('namaLengkap') || '';
        }

        async function showLanjutkanData() {
            document.getElementById('pilihanCard').classList.add('hidden');
            document.getElementById('pilihanWargaCard').classList.remove('hidden');
            document.getElementById('loadingWarga').classList.remove('hidden');

            try {
                const response = await fetch(`/api/warga/list/${localStorage.getItem('userId')}`);
                const result = await response.json();

                document.getElementById('loadingWarga').classList.add('hidden');

                if (result.success && result.data.length > 0) {
                    let html = '<div class="space-y-3">';
                    result.data.forEach(warga => {
                        html += `
                            <div onclick="pilihWarga('${warga._id}', '${warga.nama}', '${warga.noReg}')" 
                                class="bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 border border-purple-200 rounded-xl p-4 cursor-pointer transition-all transform hover:-translate-y-0.5 hover:shadow-lg">
                                <h3 class="font-bold text-purple-900 mb-1">${warga.nama}</h3>
                                <p class="text-sm text-gray-600">No Reg: ${warga.noReg}</p>
                                <p class="text-sm text-gray-600">NIK: ${warga.nik}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('wargaListContainer').innerHTML = html;
                } else {
                    document.getElementById('wargaListContainer').innerHTML = '<p class="text-center text-gray-500 py-12">Belum ada data warga. Silakan tambah warga baru.</p>';
                }
            } catch (error) {
                document.getElementById('loadingWarga').classList.add('hidden');
                console.error('Gagal memuat data warga:', error);
            }
        }

        async function showEditData() {
            document.getElementById('pilihanCard').classList.add('hidden');
            document.getElementById('editDataCard').classList.remove('hidden');
            document.getElementById('loadingEditWarga').classList.remove('hidden');

            try {
                const response = await fetch(`/api/warga/list/${localStorage.getItem('userId')}`);
                const result = await response.json();

                document.getElementById('loadingEditWarga').classList.add('hidden');

                if (result.success && result.data.length > 0) {
                    let html = '<div class="space-y-3">';
                    result.data.forEach(warga => {
                        html += `
                            <div onclick="editWarga('${warga._id}')" 
                                class="bg-gradient-to-br from-amber-50 to-orange-50 hover:from-amber-100 hover:to-orange-100 border border-amber-200 rounded-xl p-4 cursor-pointer transition-all transform hover:-translate-y-0.5 hover:shadow-lg">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-amber-900 mb-1">${warga.nama}</h3>
                                        <p class="text-sm text-gray-600">No Reg: ${warga.noReg}</p>
                                        <p class="text-sm text-gray-600">NIK: ${warga.nik}</p>
                                        <p class="text-sm text-gray-600">Dx: ${warga.dx || '-'}</p>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('editWargaListContainer').innerHTML = html;
                } else {
                    document.getElementById('editWargaListContainer').innerHTML = '<p class="text-center text-gray-500 py-12">Belum ada data warga untuk diedit.</p>';
                }
            } catch (error) {
                document.getElementById('loadingEditWarga').classList.add('hidden');
                console.error('Gagal memuat data warga:', error);
            }
        }

        async function editWarga(id) {
            currentEditWargaId = id;

            try {
                const response = await fetch(`/api/warga/detail/${id}`);
                const result = await response.json();

                if (result.success) {
                    const warga = result.data;
                    currentEditWargaNama = warga.nama;
                    
                    // Populate form
                    document.getElementById('editWargaNama').value = warga.nama;
                    document.getElementById('editWargaNIK').value = warga.nik;
                    document.getElementById('editWargaNoReg').value = warga.noReg;
                    document.getElementById('editWargaNakesKader').value = warga.nakesKader;
                    document.getElementById('editWargaDx').value = warga.dx || '';

                    // Show form
                    document.getElementById('editDataCard').classList.add('hidden');
                    document.getElementById('formEditWargaCard').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Gagal memuat detail warga:', error);
            }
        }

        function backToEditList() {
            document.getElementById('formEditWargaCard').classList.add('hidden');
            showEditData();
        }

        document.getElementById('formEditWarga').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                nama: document.getElementById('editWargaNama').value,
                nik: document.getElementById('editWargaNIK').value,
                noReg: document.getElementById('editWargaNoReg').value,
                nakesKader: document.getElementById('editWargaNakesKader').value,
                dx: document.getElementById('editWargaDx').value
            };

            try {
                const response = await fetch(`/api/warga/update/${currentEditWargaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('editAlert', 'Data warga berhasil diperbarui!', 'success');
                    setTimeout(() => {
                        showPilihan();
                    }, 1500);
                } else {
                    showAlert('editAlert', result.message, 'error');
                }
            } catch (error) {
                showAlert('editAlert', 'Terjadi kesalahan. Silakan coba lagi.', 'error');
            }
        });

        function confirmDeleteWarga() {
            document.getElementById('deleteWargaNama').textContent = currentEditWargaNama;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        async function deleteWarga() {
            try {
                const response = await fetch(`/api/warga/delete/${currentEditWargaId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    closeDeleteModal();
                    showAlert('editAlert', 'Data warga berhasil dihapus!', 'success');
                    setTimeout(() => {
                        showPilihan();
                    }, 1500);
                } else {
                    closeDeleteModal();
                    showAlert('editAlert', result.message, 'error');
                }
            } catch (error) {
                closeDeleteModal();
                showAlert('editAlert', 'Terjadi kesalahan. Silakan coba lagi.', 'error');
            }
        }

        function pilihWarga(id, nama, noReg) {
            currentWargaId = id;
            currentWargaData = { nama, noReg };
            showScreeningForm();
        }

        document.getElementById('formWarga').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                nama: document.getElementById('wargaNama').value,
                nik: document.getElementById('wargaNIK').value,
                noReg: document.getElementById('wargaNoReg').value,
                nakesKader: document.getElementById('wargaNakesKader').value,
                dx: document.getElementById('wargaDx').value,
                userId: localStorage.getItem('userId')
            };

            try {
                const response = await fetch('/api/warga/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    currentWargaId = result.warga._id;
                    currentWargaData = result.warga;
                    showScreeningForm();
                } else {
                    showAlert('wargaAlert', result.message, 'error');
                }
            } catch (error) {
                showAlert('wargaAlert', 'Terjadi kesalahan. Silakan coba lagi.', 'error');
            }
        });

        function showScreeningForm() {
            document.getElementById('formWargaCard').classList.add('hidden');
            document.getElementById('pilihanWargaCard').classList.add('hidden');
            document.getElementById('screeningCard').classList.remove('hidden');
            
            document.getElementById('screeningSubtitle').textContent = `Warga: ${currentWargaData.nama} | No Reg: ${currentWargaData.noReg}`;

            let html = '';
            pertanyaanList.forEach((p, index) => {
                html += `
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-l-4 border-purple-500 rounded-xl p-4">
                        <div class="text-sm font-semibold text-gray-800 mb-3">${index + 1}. ${p.text}</div>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="pilihJawaban('${p.key}', true, this)" 
                                class="bg-white hover:bg-emerald-50 border-2 border-gray-200 hover:border-emerald-500 text-gray-700 hover:text-emerald-700 font-semibold py-2.5 px-4 rounded-lg transition-all">
                                YA
                            </button>
                            <button type="button" onclick="pilihJawaban('${p.key}', false, this)" 
                                class="bg-white hover:bg-red-50 border-2 border-gray-200 hover:border-red-500 text-gray-700 hover:text-red-700 font-semibold py-2.5 px-4 rounded-lg transition-all">
                                TIDAK
                            </button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('pertanyaanContainer').innerHTML = html;
            document.getElementById('screeningErrorAlert').classList.add('hidden');
        }

        function pilihJawaban(key, value, btn) {
            jawaban[key] = value;
            
            const parent = btn.parentElement;
            const buttons = parent.querySelectorAll('button');
            buttons.forEach(b => {
                b.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500', 'bg-red-500', 'border-red-500', 'shadow-lg');
                b.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
            });
            
            if (value) {
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                btn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500', 'shadow-lg');
            } else {
                btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-200');
                btn.classList.add('bg-red-500', 'text-white', 'border-red-500', 'shadow-lg');
            }
            
            // Hide error alert when user answers
            document.getElementById('screeningErrorAlert').classList.add('hidden');
        }

        function hitungHasil() {
            if (Object.keys(jawaban).length < pertanyaanList.length) {
                document.getElementById('screeningErrorAlert').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            let totalSkor = 0;
            pertanyaanList.forEach(p => {
                if (jawaban[p.key] === true) {
                    totalSkor += p.nilai;
                }
            });

            let kategori, rekomendasi;
            if (totalSkor < 8) {
                kategori = 'Risiko Rendah';
                rekomendasi = 'Lakukan edukasi pencegahan preeklampsia dan anjurkan rutin periksa kehamilan';
            } else {
                kategori = 'Risiko Tinggi';
                rekomendasi = 'Segera periksakan ke bidan/puskesmas (‚â§24 jam) dan jika ada tanda bahaya langsung bawa ke IGD/Rumah sakit';
            }

            document.getElementById('hasilSkor').textContent = totalSkor;
            document.getElementById('hasilKategori').textContent = kategori;
            document.getElementById('hasilRekomendasi').textContent = rekomendasi;

            document.getElementById('screeningCard').classList.add('hidden');
            document.getElementById('hasilCard').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function simpanHasil() {
            const data = {
                wargaId: currentWargaId,
                userId: localStorage.getItem('userId'),
                pertanyaan: jawaban
            };

            try {
                const response = await fetch('/api/screening/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = '/riwayat';
                } else {
                    console.error('Gagal menyimpan hasil:', result.message);
                }
            } catch (error) {
                console.error('Terjadi kesalahan saat menyimpan:', error);
            }
        }

        function resetScreening() {
            jawaban = {};
            const buttons = document.querySelectorAll('#pertanyaanContainer button');
            buttons.forEach(btn => {
                btn.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500', 'bg-red-500', 'border-red-500', 'shadow-lg');
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-200');
            });
            document.getElementById('screeningErrorAlert').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetKeScreening() {
            jawaban = {};
            showScreeningForm();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function backToFormWarga() {
            if (currentWargaData && currentWargaData._id) {
                showPilihan();
            } else {
                showTambahBaru();
            }
        }

        function goHome() {
            window.location.href = '/home';
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            const bgColor = type === 'success' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800';
            alertDiv.innerHTML = `<div class="${bgColor} border-l-4 p-4 rounded-lg mb-4 text-sm font-medium">${message}</div>`;
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Close modal when clicking outside
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>