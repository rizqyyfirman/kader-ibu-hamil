<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat - PreeCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7c3aed',
                        secondary: '#ec4899',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-purple-50 via-white to-pink-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ðŸ“Š</span>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        Riwayat Screening
                    </h1>
                </div>
                <button onclick="goHome()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold px-4 py-2 rounded-xl text-sm shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                    Home
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingRiwayat" class="text-center py-20">
            <div class="inline-block w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
            <p class="text-sm text-gray-500 mt-4">Memuat data riwayat...</p>
        </div>

        <!-- List Riwayat -->
        <div id="riwayatCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-900">Data Riwayat Screening</h2>
                <button onclick="downloadExcel()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold px-4 py-2 rounded-xl text-sm shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Excel
                </button>
            </div>
            <div id="riwayatContainer"></div>
        </div>

        <!-- Detail Warga -->
        <div id="detailWargaCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="backToList()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <div id="detailWargaContainer"></div>
        </div>

        <!-- Detail Screening -->
        <div id="detailScreeningCard" class="hidden bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
            <button onclick="backToDetailWarga()" class="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-semibold mb-4 transition-all hover:gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Kembali
            </button>
            <div id="detailScreeningContainer"></div>
        </div>

    </div>

    <script>
        if (!localStorage.getItem('token')) {
            window.location.href = '/';
        }

        let currentWargaData = null;
        let currentScreenings = null;

        const pertanyaanText = {
            'penghasilanKurangUMR': 'Penghasilan < UMR',
            'hamilLebihSatuKali': 'Hamil lebih dari 1 kali',
            'keturunanKeracunan': 'Ada Keturunan Preeklampsia',
            'usiaBerisiko': 'Usia < 20 th atau > 35 th',
            'riwayatTekananDarah': 'Ada Riwayat tekanan darah tinggi',
            'gemuk': 'Gemuk (IMT > 25)',
            'riwayatKeracunan': 'Ada Riwayat Preeklampsia',
            'riwayatDM': 'Ada Riwayat kencing manis (DM)'
        };

        window.addEventListener('DOMContentLoaded', loadRiwayat);

        async function loadRiwayat() {
            try {
                const response = await fetch(`/api/screening/riwayat/${localStorage.getItem('userId')}`);
                const result = await response.json();

                document.getElementById('loadingRiwayat').classList.add('hidden');
                document.getElementById('riwayatCard').classList.remove('hidden');

                if (result.success && result.data.length > 0) {
                    let html = '<div class="space-y-3">';
                    
                    result.data.forEach(item => {
                        const warga = item.warga;
                        const jumlahScreening = item.screenings.length;
                        const latestScreening = item.screenings[0];
                        
                        const badgeClass = latestScreening.kategoriRisiko === 'Risiko Rendah' 
                            ? 'bg-emerald-100 text-emerald-800' 
                            : 'bg-red-100 text-red-800';
                        
                        html += `
                            <div onclick='showDetailWarga(${JSON.stringify(item).replace(/'/g, "&apos;")})' 
                                class="bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 border border-purple-200 hover:border-purple-300 rounded-xl p-4 cursor-pointer transition-all transform hover:-translate-y-0.5 hover:shadow-lg">
                                <h3 class="font-bold text-purple-900 mb-2">${warga.nama}</h3>
                                <div class="space-y-1 text-sm text-gray-600 mb-3">
                                    <p>No Reg: ${warga.noReg}</p>
                                    <p>NIK: ${warga.nik}</p>
                                    <p>Jumlah Pemeriksaan: ${jumlahScreening} kali</p>
                                </div>
                                <span class="${badgeClass} text-xs font-semibold px-3 py-1.5 rounded-full inline-block">
                                    Terakhir: ${latestScreening.kategoriRisiko}
                                </span>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    document.getElementById('riwayatContainer').innerHTML = html;
                } else {
                    document.getElementById('riwayatContainer').innerHTML = '<p class="text-center text-gray-500 py-20">Belum ada data riwayat screening.</p>';
                }
            } catch (error) {
                document.getElementById('loadingRiwayat').classList.add('hidden');
                console.error('Gagal memuat data riwayat:', error);
            }
        }

        function showDetailWarga(data) {
            currentWargaData = data.warga;
            currentScreenings = data.screenings;

            document.getElementById('riwayatCard').classList.add('hidden');
            document.getElementById('detailWargaCard').classList.remove('hidden');

            let html = `
                <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 text-white mb-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-3">${currentWargaData.nama}</h2>
                    <div class="space-y-1 text-sm opacity-95">
                        <p>No Reg: ${currentWargaData.noReg}</p>
                        <p>NIK: ${currentWargaData.nik}</p>
                        <p>Nakes/Kader: ${currentWargaData.nakesKader}</p>
                        <p>Dx: ${currentWargaData.dx}</p>
                    </div>
                </div>
                
                <h3 class="text-lg font-bold text-gray-900 mb-4">Riwayat Pemeriksaan</h3>
                <div class="space-y-3">
            `;

            currentScreenings.forEach((screening, index) => {
                const tanggal = new Date(screening.tanggalPemeriksaan).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                const badgeClass = screening.kategoriRisiko === 'Risiko Rendah' 
                    ? 'bg-emerald-100 text-emerald-800' 
                    : 'bg-red-100 text-red-800';

                html += `
                    <div onclick="showDetailScreening(${index})" 
                        class="bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 border border-purple-200 hover:border-purple-300 rounded-xl p-4 cursor-pointer transition-all transform hover:-translate-y-0.5 hover:shadow-lg">
                        <h4 class="font-bold text-purple-900 mb-2">Pemeriksaan #${currentScreenings.length - index}</h4>
                        <div class="space-y-1 text-sm text-gray-600 mb-3">
                            <p>Tanggal: ${tanggal}</p>
                            <p>Total Skor: ${screening.totalSkor}</p>
                        </div>
                        <span class="${badgeClass} text-xs font-semibold px-3 py-1.5 rounded-full inline-block">
                            ${screening.kategoriRisiko}
                        </span>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('detailWargaContainer').innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showDetailScreening(index) {
            const screening = currentScreenings[index];
            
            document.getElementById('detailWargaCard').classList.add('hidden');
            document.getElementById('detailScreeningCard').classList.remove('hidden');

            const tanggal = new Date(screening.tanggalPemeriksaan).toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let html = `
                <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 text-white mb-6 shadow-lg">
                    <h2 class="text-xl font-bold mb-2">Detail Pemeriksaan</h2>
                    <p class="text-sm opacity-95">${currentWargaData.nama} - ${currentWargaData.noReg}</p>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 mb-4 border border-gray-200">
                    <h3 class="text-base font-bold text-purple-900 mb-3">Informasi Umum</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tanggal Pemeriksaan:</span>
                            <span class="font-semibold text-gray-900">${tanggal}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Nakes/Kader:</span>
                            <span class="font-semibold text-gray-900">${currentWargaData.nakesKader}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Dx:</span>
                            <span class="font-semibold text-gray-900">${currentWargaData.dx}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 mb-4 border border-gray-200">
                    <h3 class="text-base font-bold text-purple-900 mb-3">Hasil Screening</h3>
                    <div class="space-y-2">
            `;

            let no = 1;
            for (let key in pertanyaanText) {
                const jawaban = screening.pertanyaan[key] ? 'YA' : 'TIDAK';
                const nilai = screening.scoring[key];
                const jawabanClass = screening.pertanyaan[key] 
                    ? 'text-emerald-700 font-semibold' 
                    : 'text-red-700 font-semibold';
                
                html += `
                    <div class="flex justify-between text-sm py-2 border-b border-gray-200 last:border-b-0">
                        <span class="text-gray-700">${no}. ${pertanyaanText[key]}</span>
                        <span class="${jawabanClass}">${jawaban} (${nilai})</span>
                    </div>
                `;
                no++;
            }

            html += `
                    <div class="flex justify-between pt-3 mt-3 border-t-2 border-purple-300">
                        <span class="text-base font-bold text-purple-900">Total Skor:</span>
                        <span class="text-lg font-bold text-purple-700">${screening.totalSkor}</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 text-center text-white shadow-lg">
                <h3 class="text-lg font-bold mb-3">Kategori Risiko</h3>
                <div class="text-2xl font-bold bg-white/20 backdrop-blur-sm rounded-xl py-3 px-6 mb-4 inline-block">
                    ${screening.kategoriRisiko}
                </div>
                <div class="text-sm leading-relaxed opacity-95">
                    <strong>Rekomendasi:</strong><br>
                    ${screening.rekomendasi}
                </div>
            </div>
            `;

            document.getElementById('detailScreeningContainer').innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function backToDetailWarga() {
            document.getElementById('detailScreeningCard').classList.add('hidden');
            document.getElementById('detailWargaCard').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function backToList() {
            document.getElementById('detailWargaCard').classList.add('hidden');
            document.getElementById('riwayatCard').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goHome() {
            window.location.href = '/home';
        }

        async function downloadExcel() {
            try {
                const userId = localStorage.getItem('userId');
                
                // Show loading state
                const originalButton = event.target.closest('button');
                const originalHTML = originalButton.innerHTML;
                originalButton.disabled = true;
                originalButton.innerHTML = `
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Mengunduh...</span>
                `;

                const response = await fetch(`/api/screening/download-excel/${userId}`);
                
                if (!response.ok) {
                    throw new Error('Gagal mengunduh file');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Riwayat_Screening_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Restore button
                originalButton.disabled = false;
                originalButton.innerHTML = originalHTML;
            } catch (error) {
                console.error('Error downloading Excel:', error);
                alert('Gagal mengunduh file Excel. Silakan coba lagi.');
                
                // Restore button on error
                const button = event.target.closest('button');
                button.disabled = false;
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Excel
                `;
            }
        }
    </script>
</body>
</html>